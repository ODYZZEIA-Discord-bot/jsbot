# Discord Bot 处罚系统实现计划

## 已完成的重构

### 定时任务重构
- 创建了 `tasks/scheduler.js` 统一管理定时任务
- 实现了任务的优雅停止和资源清理
- 改进了 `index.js` 中的退出处理机制
- 添加了任务监控和错误处理

### 交互处理系统重构
- 创建了 `handlers` 目录统一管理交互处理
- 实现了按钮和模态框的统一处理
- 抽象了通用的确认按钮逻辑
- 优化了交互响应的错误处理

### 并发控制优化
- 优化了 `concurrency.js` 中的资源管理
- 添加了清理机制防止内存泄漏
- 改进了请求队列的状态管理
- 实现了更可靠的任务优先级调度

## 项目概述

处罚系统是一个复杂的多阶段功能，包含以下主要模块：
- 基础处罚执行
- 上诉机制
- 议事投票
- 跨服务器同步
- 定时任务处理

## 实现阶段

### 第一阶段：定时任务重构和基础处罚框架（预计3天）

1. 定时任务重构
   - 创建 `tasks/scheduler.js`
   - 迁移现有定时任务
   - 实现统一的任务管理
   - 添加任务监控和错误处理

2. 数据库设计
   - 创建处罚记录数据库（MongoDB）
   ```javascript
   PunishmentSchema = {
     userId: String,
     guildId: String,
     type: String, // 'ban'|'mute'|'warn'
     reason: String,
     duration: Number,
     expireAt: Date,
     executorId: String,
     status: String,
     synced: Boolean,
     syncedServers: [String]
   }
   ```
   - 创建流程记录数据库
   ```javascript
   ProcessSchema = {
     punishmentId: String,
     type: String, // 'appeal'|'vote'|'debate'
     status: String,
     createdAt: Date,
     expireAt: Date,
     messageIds: [String],
     votes: Map<String, String>
   }
   ```

3. 基础命令实现
   - `/处罚 永封` 命令
   - `/处罚 禁言` 命令
   - 基础权限检查
   - 参数验证
   - 处罚执行

4. 消息通知系统
   - 公示消息发送
   - 私聊通知
   - 处罚日志记录

### 第二阶段：上诉控件系统（预计3天）

1. 上诉控件开发
   - 创建上诉按钮组件
   - 上诉表单模态框
   - 上诉信息验证

2. 议事区集成
   - 议事消息创建
   - 匿名点赞系统
   - 点赞统计更新

3. 上诉流程管理
   - 上诉状态追踪
   - 控件有效期管理
   - 上诉权限控制

### 第三阶段：辩诉投票系统（预计3天）

1. 辩诉区功能
   - 辩诉帖子创建
   - 权限动态管理
   - 投票器控件

2. 投票机制
   - 投票权限验证
   - 票数统计系统
   - 拔河图显示

3. 结果处理
   - 投票结果计算
   - 处罚状态更新
   - 结果公示

### 第四阶段：跨服务器同步（预计2天）

1. 同步机制
   - 服务器间数据同步
   - 处罚执行同步
   - 状态一致性检查

2. 错误处理
   - 同步失败处理
   - 重试机制
   - 日志记录

### 第五阶段：定时任务完善（预计2天）

1. 处罚系统定时任务
   - 处罚到期检查
   - 警告清理
   - 状态更新

2. 投票时间管理
   - 12小时公开制
   - 24小时结束机制
   - 投票权重计算

### 第六阶段：优化和测试（预计3天）

1. 性能优化
   - 数据库查询优化
   - 并发处理优化
   - 内存使用优化

2. 错误处理完善
   - 异常捕获
   - 错误恢复
   - 用户反馈

3. 测试用例
   - 单元测试
   - 集成测试
   - 压力测试

## 注意事项

1. 代码规范
   - 遵循项目现有的代码风格
   - 模块化设计
   - 清晰的注释和文档

2. 数据安全
   - 数据备份机制
   - 权限严格控制
   - 敏感信息保护

3. 用户体验
   - 清晰的错误提示
   - 合理的操作延迟
   - 友好的交互界面

## 依赖管理

需要添加的新依赖：
```json
{
  "dependencies": {
    "mongoose": "^8.0.0",
    "date-fns": "^3.0.0",
    "node-schedule": "^2.1.1"
  }
}
```

## 文件结构

新增文件结构：
```
├── commands/
│   ├── adm_punish.js           # 处罚命令
│   ├── mod_appeal.js           # 上诉命令
│   └── mod_debate.js           # 辩诉命令
├── models/
│   ├── punishment.js           # 处罚数据模型
│   └── process.js              # 流程数据模型
├── utils/
│   ├── punishment.js           # 处罚工具函数
│   ├── appeal.js              # 上诉工具函数
│   ├── debate.js              # 辩诉工具函数
│   └── sync.js                # 同步工具函数
``` 